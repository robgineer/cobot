<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Robert Harbach / Thao Dang" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Trajectory Controller - Cobot Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Trajectory Controller";
        var mkdocs_page_input_path = "cobot_trajectory_controller.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Cobot Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Overview</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../quickstart/">Quickstart</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Graphical User Interfaces</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../gui_overview/">VNC vs Xpra</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../howToVNC/">VNC</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../howToXpra/">Xpra</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Configuration</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../cobot_model_overview/">Cobot Model Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cobot_configuration/">MoveIt2 and ROS2 Control Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../launch_files/">Launch Files Explained</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Controls</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Trajectory Controller</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#implementation-overview">Implementation Overview</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#implementation-details">Implementation Details</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#command_interface_configuration-state_interface_configuration">command_interface_configuration / state_interface_configuration</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#on_configure">on_configure</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#goal_callback">goal_callback</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#update">update</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#resampling">Resampling</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cobotapisrv">CobotApiSrv</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cobot_hardware/">Hardware Interface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../controller_manager/">Controller Manager</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Evaluation and Calibration</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../planner_evaluation/">Planner Evaluation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../offline_hand_eye/">Hand-eye-calibration</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Cobot Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Controls</li>
      <li class="breadcrumb-item active">Trajectory Controller</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/robgineer/cobot/edit/master/docs/cobot_trajectory_controller.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="cobot-trajectory-controller">Cobot Trajectory Controller<a class="headerlink" href="#cobot-trajectory-controller" title="Permanent link">&para;</a></h1>
<p>Custom ROS2 controller for the Cobot.
This controller works only in combination with the <code>cobot_hardware</code> package and aims to control the real Cobot.</p>
<p>In order to manipulate the Cobot in ROS2, make sure you have pulled the <code>cobot_hardware</code> submodule. Run this controller with</p>
<pre><code class="language-bash">ros2 launch demo rviz_demo_launch.py controller_type:=real
</code></pre>
<h2 id="implementation-overview">Implementation Overview<a class="headerlink" href="#implementation-overview" title="Permanent link">&para;</a></h2>
<p>We have two options to pass commands to the Cobot API: single point (the final point of a trajectory, via <code>SetRobotWaypoint</code>) or a list of points (via <code>ExecuteInstructionList</code>, representing a path). We cannot send actual trajectories or fine grained position commands as the SPS of the Cobot takes care of the trajectory (and we cannot by-pass the SPS).</p>
<p>This, unfortunately, does not align with the ROS2 control principles. A basic overview of the trajectory generation and control is provided in the following:</p>
<pre><code class="language-text">MoveIt Planning (OMPL) → Generates a collision free path
                ↓
Time Parameterization Plugin (Iterative / TOTG) → Adds time (making it an actual trajectory)
                ↓
Final RobotTrajectory message
                ↓
MoveIt Simple Controller Manager
                ↓
ros2_control controller
                ↓
HardwareInterface
</code></pre>
<p>The ROS2 controllers are designed to send position commands to the hardware in real time; which is not suitable for the Cobot. </p>
<p>In previous implementations, we simply sent the final trajectory point to the Cobot (using a custom MoveItControllerManager, <em>the CobotControllerManager</em>). Although this resulted in smooth movements of the Cobot arm, the resulting trajectory was calculated by the SPS. We therefore had no influence on the trajectory and collisions that were considered within trajectory planning were obsolete. Hence, even with a camera attached, the Cobot would have been blind.</p>
<p>In order to overcome this limitation we use the instruction list mechanism, where we pass a list of points to the Cobot and since the standard implementation of the ROS2 trajectory controller does not allow to send full trajectories (or lists of points), we are using this custom ROS2 controller, that send out either the last point of a trajectory or the entire trajectory to this interface.
Note: ROS2 control implies using single joint commands (declared as double) and since a full trajectory was therefore difficult to be passed, we introduced another communication feature: a singleton realtime buffer.</p>
<pre><code class="language-text">MoveIt Planning (OMPL) → Generates a collision free path
        ↓
Time Parameterization Plugin (Iterative / TOTG) → Adds time (making it an actual trajectory)
        ↓
Final RobotTrajectory message
        ↓
MoveIt Simple Controller Manager
        ↓
cobot_trajectory_controller (this package)
        ↓ trajectory (via shared buffer)
cobot_hardware
</code></pre>
<h2 id="implementation-details">Implementation Details<a class="headerlink" href="#implementation-details" title="Permanent link">&para;</a></h2>
<p>The Cobot Trajectory Controller forwards trajectories to the hardware interface in three steps:</p>
<ol>
<li>accept a trajectory from the MoveItSimpeControllerManager,</li>
<li>resample the trajectory points (optional) and</li>
<li>place the entire trajectory or its last point into a shared buffer for the hardware interface.</li>
</ol>
<p>A communication overview between MoveIt2, the Cobot Trajectory Controller and the hardware interface is provided in the following.</p>
<p><img alt="cobot_traj_controller" src="../img/cobot_traj_controller.png" /></p>
<p>List of the major functions implemented:</p>
<pre><code class="language-cpp">    /*
     * Expose the command interfaces to the controller manager
     */
    command_interface_configuration()

    /*
     * Expose the state interfaces to the controller manager
     */
    state_interface_configuration()

    /*
     * Configure ROS2 environment
     */
    on_configure(const rclcpp_lifecycle::State &amp;previous_state)

    /*
     * Callback for reception of /follow_joint_trajectory
     */
    goal_callback(...)

    /*
     * Communication with the hardware interface.
     * Fills a realtime buffer with a trajectory for the hardware interface.
     */
    update(const rclcpp::Time &amp;time, const rclcpp::Duration &amp;period)

    /*
     * Spatial trajectory resampling for the reduction of points.
     */
    resample_trajectory(const trajectory_msgs::msg::JointTrajectory &amp;trajectory)

    /*
     * Initiate the service (cobot_api_service_) between this controller
     * and the rviz panel
     */
    setup_service_for_rviz_panel()
</code></pre>
<p>Graphical overview of function interactions:</p>
<p><img alt="cobot_traj_controller_internal" src="../img/cobot_traj_controller_internal.png" /></p>
<h3 id="command_interface_configuration-state_interface_configuration">command_interface_configuration / state_interface_configuration<a class="headerlink" href="#command_interface_configuration-state_interface_configuration" title="Permanent link">&para;</a></h3>
<p>We claim the states published by the cobot hardware interface as well as the commands send to the hardware interface. This has to be aligned with the ros2 control configuration. Refer <code>cobot_moveit_config/ros2_controllers.yaml</code></p>
<pre><code class="language-yaml"> cobot_arm_group_controller:
      type: cobot_trajectory_controller/CobotTrajectoryController
 #...
 cobot_arm_group_controller:
  ros__parameters:
    joints:
      - joint_0
      - joint_1
      - joint_2
      - joint_3
      - joint_4
      - joint_5
      - joint_6
    command_interfaces:
      - position
    state_interfaces:
      - position
      - velocity
</code></pre>
<p><strong>Note</strong> we do not access the <code>state_interfaces</code> in this controller; which is a rather unlikely setup. In a standard controller, we would read the states of the joints and adapt our control commands based on the current state of each joint =&gt; what a rea-time controller usually does. Since we do not have any influence on the trajectory execution (which is handled by the Cobot SPS), we simply claim the states (as defined in the configuration) but do not read them. Reading and publishing the states for the remaining system is handled byt the <code>joint_state_broadcaster</code>.</p>
<h3 id="on_configure">on_configure<a class="headerlink" href="#on_configure" title="Permanent link">&para;</a></h3>
<ol>
<li>Defines an <code>action_server</code> that listens to the <code>/follow_joint_trajectory</code> and executes <code>goal_callback(...)</code> on reception of the topic.</li>
<li>Sets ROS2 parameters for <code>execution_mode</code> as well as the corresponding <code>resampling_delta</code>. </li>
</ol>
<p><code>execution_mode = single_point</code> only the last point of a trajectory is send to the hardware interface.
<code>execution_mode = full_trajectory</code> the full trajectory is send to the hardware interface.
<code>resampling_delta</code> defines the spacial minimum delta between two trajectory points. This implementation enables smoother motions on the Cobot. If we send out a trajectory that has too many points, the Cobot's SPS will only be able to execute these with a jerky movement.</p>
<h3 id="goal_callback">goal_callback<a class="headerlink" href="#goal_callback" title="Permanent link">&para;</a></h3>
<p>Fills an internal trajectory buffer on reception of <code>/follow_joint_trajectory</code>. This is required due to the asynchronous execution of <code>update</code> and the reception of the <code>/follow_joint_trajectory</code> topic.</p>
<h3 id="update">update<a class="headerlink" href="#update" title="Permanent link">&para;</a></h3>
<p>The ROS2 Control Manager calls this function periodically. The implementation checks if the internal trajectory buffer was updated and runs an optional re-sampling of the received trajectory.</p>
<p><strong>Note</strong> we slowed down the periodic execution of this function from <code>100</code> hz (default) to <code>10</code> hz. Background: since we do not have real-time control, a high frequency execution is not required. Refer: <code>cobot_moveit_config/ros2_controllers.yaml</code></p>
<h3 id="resampling">Resampling<a class="headerlink" href="#resampling" title="Permanent link">&para;</a></h3>
<p>Spatial trajectory resampling for the reduction of points.</p>
<p>In case full trajectory forwarding is active (<code>execution_mode == full_trajectory</code>), we forward the entire trajectory to the hardware interface.</p>
<p>Since the Cobot does not accept timing based commands but a path and since dense trajectory points imply jerky movements, we resample the trajectory based on a minimum distance between two subsequent trajectory points. This can be adjusted using the parameter: <code>resampling_delta</code>.</p>
<pre><code class="language-text">Example with resampling_delta = 0.5

Trajectory point:     0     1     2     3     4     5     6     7     8
 --------------------------------------------------------------------------
Joint_1 pos (rad):   0.0   0.2   0.4   0.6   0.8   1.0   1.2   1.4   1.6
Selected:             -     -     #     -     -     #     -     -     #
Joint_2 pos (rad):   0.0   0.2   0.4   0.6   0.8   1.0   1.0   1.0   1.0
Selected:             -     -     -     -     -     -     -     -     #

 # = selected point
 - = skipped point (delta &lt; resampling_delta)

Resampled trajectory point:     0     1     2
 -----------------------------------------------
 Resampled joint_1 pos (rad):   0.4   1.0   1.6
 Resampled joint_2 pos (rad):   0.4   1.0   1.0

Note: in practice all joints move with the same velocity
(we have defined the same limits for each joint in the configurations)
</code></pre>
<p>Graphical interpretation of  trajectory resampling on real data (joint 5):</p>
<pre><code class="language-text">number of initial traj. points: 68
resampling_delta: 0.3
=&gt;  number of resampled traj. points: 5
</code></pre>
<p><img alt="resampling_joint_5" src="../img/resampling_joint_5.png" /></p>
<h3 id="cobotapisrv">CobotApiSrv<a class="headerlink" href="#cobotapisrv" title="Permanent link">&para;</a></h3>
<p><code>execution_mode</code> and <code>resampling_delta</code> are defined as parameters that can be updated on demand using:</p>
<pre><code class="language-bash">ros2 param set /cobot_arm_group_controller execution_mode full_trajectory
ros2 param set /cobot_arm_group_controller resampling_delta 0.3
</code></pre>
<p>In order to increase usability, we have implemented a small rviz plugin that communicates with the Cobot Trajectory Controller and that enables updating these parameters in rviz.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../launch_files/" class="btn btn-neutral float-left" title="Launch Files Explained"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../cobot_hardware/" class="btn btn-neutral float-right" title="Hardware Interface">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Authors <a href="https://github.com/robgineer"> Robert Harbach </a> / <a href="https://github.com/td-code"> Thao Dang </a></p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/robgineer/cobot" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../launch_files/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../cobot_hardware/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
